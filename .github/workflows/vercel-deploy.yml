name: Medpoint App Deployment

on:
  push:
    tags:
      - "v*" # Menjalankan pipelane ketika previx dari push tagnya 'v' (example: v1.0.1)

env:
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
  GITEA_TOKEN: ${{ secrets.GITEA_ACCESS_TOKEN }}
  GITEA_USERNAME: ${{ secrets.GITEA_USERNAME }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          git config --global url."https://$GITEA_USERNAME:$GITEA_TOKEN@gitea.sev-2.com".insteadOf "ssh://gitea.sev-2.com"
          yarn install --network-timeout 300000

      - name: Build dengan Vercel
        run: |
          npx vercel build --prod --token=$VERCEL_TOKEN

      - name: Deploy PREBUILT
        run: |
          npx vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
